# RMarkdown

## Objetivos

- Explorar RMarkdown
- Introducción a las funciones básicas incluidas en RStudio
- Aprender como usar las páginas de ayuda

## Introducción
Ahora que conocer un poco de la sintaxis básica de R, podemos comenzar a aprender sobre
RMarkdown. La experiencia nos dice que te vas a volver loco y aun así a fallar en generar
un flujo de trabajo reproducible, si tratas de desarrollar código directamente en la 
consola de R. RMarkdown es realmente clave para la investigación colaborativa, es por 
esto que vamos a comenzar con esto rápidamente y lo usaremos durante el resto de este 
curso.

Un archivo de RMarkdown no va a ayudar a tejer un texto _markdown_ con fragmentos de 
código de R que es evaluado y cuyas salidas, como tables y gráficos, son incluidas en el 
documento.

Para abrir un nuevo documento de RMarkdown siga los siguiente pasos:

File -> New File -> RMarkdown... -> Document of output format HTML, OK.


```{r RStudioNew, echo=FALSE, out.width = '75%', fig.align = 'center', fig.cap = 'Captura de pantalla de la interfase para la creación de un proyecto nuevo de RStudio.'}
knitr::include_graphics("images/5.1_rstudio_new-rmd-doc-html.png")
```

Le puede dar un título como "Mi Proyecto". Luego clic en OK. 

OK, primero que todo: Al abrir el archivo, vamos a ver un 4° panel de la consola de RStudio, 
este panel es un editor de texto. Este panel editor nos permite abrir varios archivos en 
un único panel.

Ahora démosle una mira a este archivo - a primera vista se puede ver que no está en blanco;
hay un texto inicial que se entrega por defecto. Hay algunas cosas que identificar en el texto: 

- Está en inglés (no se preocupe, lo vamos a reescribir!)
- Hay secciones en blanco y otras en negro. El código R está en las secciones plomas, mientras
que el texto está con fondo blando (por defecto, este color del fondo se puede cambiar). 

```{r rmarkdown, echo=FALSE, out.width = '100%', fig.align = 'center', fig.cap = 'Imagen con el código fuente de un archivo RMarkdown.'}
knitr::include_graphics("images/5.2_rmarkdown.png")
```

<br>

Lo primero que vamos a hacer es hacer generar el código HTML (Knit HTML) haciendo clic 
en la pelota de lana azul en la parte superior del panel con el archivo RMarkdown. 
Cuando haga clic por primera vez en este botón, RStudio pedirá que guarde este archivo. 
Cree un nuevo directorio en algún lugar que le sea fácil encontrarlo posteriormente
(por ejemplo Escritorio o Mis Documentos) y dele un nombre que tenga sentido y le permita
recordarlo después (ej: `clase_rmarkdown`).

<br>

```{r rmarkdownSideSide, echo=FALSE, out.width = '100%', fig.align = 'center', fig.cap = 'Imagen con el código fuente y pagina resultante de un archivo RMarkdown.'}
knitr::include_graphics("images/5.3_rmarkdown_side_by_side.png")
```


¿Que cosas puede notar entre al comparar los dos archivos? 

Las **secciones de código R** plomas están rodeadas de 3 tics y `{r LABEL}`.
Estas secciones son evaluadas, generando una salida de texto en el caso de 
`summary(cars)` y de un gráfico en el caso de `plot(pressure)`.

Note como el código `plot(pressure)` no se muestra en la salida HTML porque 
la sección de código R tiene la opción `echo=FALSE`.

Algunos otros detalles...

Este archivo de RMarkdown tiene 2 lenguajes incluidos: **R** y **Markdown**. 

Aun no sabemos mucho de R, pero ya puede ver que estamos tomando el 
resumen de los datos llamados 'cars' y luego los graficamos. Hay mucho más
para aprender sobre R y vamos a trabajar eso en las próximas clases.

El segundo lenguaje que incluyo el archivo es Markdown. Este es un lenguaje
que para dar formato a texto plano y solo hay aproximadamente 15 reglas para 
conocer.

Vea la siguiente sintaxis:

- **Títulos**: son procesador en múltiples niveles con: `#`, `##`
- **Negrita**: `**palabra**`

Hay muchas tablas [cheatsheets](https://github.com/adam-p/markdown-here/wiki/Markdown-Here-Cheatsheet)
que te puede ayudar a comenzar y una de esas está incluida en RStudio: para abrirla vaya a Help > Markdown Quick Reference
<br />
<br />

**Importante**: El símbolo de gato, número o para los milenials hashtag `#` tiene un 
significado diferente si es usado en Markdown o en R: 

- en R, un gato indica que es un comentario y no será evaluado. Se pueden usar tantos como 
se quiera: `#` es equivalente a `######`. Es sólo una cuestión de estilos.
- en Markdown, un gato indica el nivel del título. Y cuantos use tienen un efecto:
`#` es un "título nivel 1", lo que significa que es la fuente de mayor tamaño y que
está al tope de la jerarquía. `###` es un título nivel 3 y se muestra anidado bajo el 
título `#` y `##`.

Más sobre esto en: http://rmarkdown.rstudio.com/

### Actividad

1. En Markdown, escriba un texto en cursiva (Itálica) y haga una lista numerada. Luego 
agregue algunos subtítulos. Use la Referencia de Uso Rápido de Markdown (en barra del menú: 
Help > Markdown Quick Reference). 
1. Haga clic en Knit para crear su archivo html. 


### Secciones de código

OK. Ahora practiquemos con algunos comandos de R.

Cree una nueva sección en en su RMarkdown siguiendo alguno de estos pasos:

- clic "Insert > R" en la parte superior del panel de edición.
- Escriba a mano 
   \```{r}
   \```
- si no ha borrado una sección de las que venían con el archivo creado por defecto, 
edite esa

Ahora escribamos un poco de código de R. 

```
x <- 4*3
x
```

Ahora al apretar la tecla enter el comando no se ejecuta; recuerde que esto
es solo un archivo de texto. Para ejecutarlo, tenemos que ejecutar lo que escribimos
dentro de la sección de R (el código R en plomo) en la consola. ¿Cómo se hace eso?
Hay varias formas de hacerlo:

1. Copiar y pegar los comando en la consola.
1. Seleccionar la linea (o poner el curso en ella) y hacer clic en 'Run'. Esto está 
disponible desde:
    a. la barra arriba del archivo (flecha verde)
    b. la barra menú: Code > Run Selected Line(s)
    c. combinación de teclas: control-enter en Windows o command-enter en macOS.
1. Clic en la flecha verde en el lado superior derecho de su sección de código.

### Actividad

Agregue algunos otros comandos a su archivo. Ejecútelos de las tres formas indicadas
más arriba. Finalmente, guarde su archivo RMarkdown. 


## Funciones de R

Hasta ahora hemos aprendido alguna sintaxis básica y conceptos de programación en 
R, como navegar en RStudio y RMarkdown, pero no hemos hecho nada complicado o 
interesantes. Aquí es donde las _funciones_ son útiles.

Una función es una forma de agrupar una serie de comandos para desarrollar una
tarea en una forma reusable. Cuando una función es ejecutada, se produce un valor
de salida. Nosotros generalmente deciros que "llamamos" a una función cuando
la ejecutamos. Lo interesante sobre las funciones es que pueden ser creadas por 
los usuarios y guardadas como un objeto usando el operador de asignación ('<-'),
de esta forma es posible escribir una función para lo que sea que se necesite. 
Tenga en cuenta que R tiene una colección gigantesca de funciones pre-existentes.
Para comenzar, vamos a usar algunas funciones de incluidas en R.

Todas las funciones se llaman usando la misma sintaxis: nombre de la función 
seguido de un paréntesis donde se entregan lo que necesita la función para hacer
lo que fue creada para hacer. Las piezas de información que la función necesita 
para hacer su trabajo se conocen como argumentos. De esta forma, la sintaxis 
para usar una función se ve así: 
`valor_resultante <- nombre_de_función(argumento1 = valor1, argumento2 = valor2, ...)`. 

### Ejemplo simple

Para tomar un ejemplo muy simple, vamos a utilizar la función para calcular el promedio
`mean()`. Como se lo puede imaginar, esta función calcula el promedio de los números
entregados como argumentos. Super útil!

Creemos un vector con los pesos:

```{r}
peso_kg <- c(55, 25, 12)
```

y ahora usemos la función `mean` para calcular el peso promedio.

```{r}
mean(peso_kg)
```

## Páginas de ayuda

### Obteniendo ayuda

¿Qué pasaría ahora si sabe cual es la función que necesita pero no 
sabe como funciona? Afortunadamente RStudio entrega una forma muy fácil para acceder
a las páginas de documentación y ayuda.

Para acceder a la ayuda para la función `mean`, entre el siguiente comando en la consola:

```{r, eval = F}
?mean
```

Esto va a abrir el panel de ayuda en la sección inferior derecha de RStudio.

Las páginas de ayuda están dividas en secciones, la documentación está en inglés:

 - Description: Se entrega una descripción extendidas de lo que hace la función.
 - Usage: Los argumentos de la función(es) y sus valores por defecto.
 - Arguments: Una explicación de los datos que cada argumento está esperando.
 - Details: Cualquier detalle que sea relevante conocer.
 - Value: Los datos que la función devuelve.
 - See Also: Otras funciones que podrían resultar útiles en este contexto.
 - Examples: Algunos ejemplos de como usar la función.


### Actividad

> Ejercicio: Hable con su vecino(s) y dele una mirada a las ayudas de algunas 
funciones que usted estará que existan. Aquí les dejo algunas ideas: `?getwd()`,
`?plot()`,  `min()`, `max()`, `?log()`.

También existe ayuda para cuando usted no está seguro del nombre de la función, 
en esos casos de usar doble símbolo de pregunta:

```{r, eval=F}
??install 
```

No todas las funciones tienen (o requieren) argumentos:
```{r}
date()
```

### Leyendo un archivo de datos a R

Hasta ahora hemos aprendido como asignar valores a objetos de R y lo que es una
función, pero no hemos hecho nada aun con datos reales. Para hacer eso, es necesario
introducir la función `read.csv`, la que usaremos generalmente en las primeras líneas
del código que escribamos. Esta función hace exactamente lo que dice (en inglés!),
lee un archivo _csv_ a R.

Ya que esta será nuestra primera vez usando esta función, primero leeremos la página de 
ayuda de `read.csv`. La ayuda tiene mucha información y acepta muchos argumentos, sin 
embargo el primero de ellos es el mas importante - tenemos que decirle que archivo
es el que va a leer. 

#### Descargue un archivo desde el Arctic Data Center

Navegue al set de datos de Craig Tweedie que está publicado en el Arctic Data Center. 
[Craig Tweedie. 2009. North Pole Environmental Observatory Bottle Chemistry. Arctic 
Data Center. doi:10.18739/A25T3FZ8X.](http://doi.org/10.18739/A25T3FZ8X) y descargue 
el primer archivo _csv_ llamado "BGchem2008data.csv"

Mueva este archivo desde su carpeta de Descargas a un directorio de fácil acceso. 
Yo recomiendo crear un directorio llamado `datos` en el directorio que creo anteriormente
para para las otras actividades de esta clase.

Ahora tenemos que decirle a la función `read.csv` como encontrar el archivo que queremos
leer. Para esto se usa el argumento `file` (archivo) que se puede ver en la sección 
usage (uso) de la página de ayuda. En RMarkdown, se puede usar path absolutos (que comienzan
con su directorio `~/`) o path relativos, que son **relativos a la ubicación del archivo
RMarkdown**. RStudio y RMarkdown tiene la capacidad de autocompletar cuando se usar paths
relativos, por lo que usaremos ese sistema. Asumiendo que ya movió el archivo a el directorio
dentro de la carpeta `archivos_clase_R` que se llama `datos`, su función `read.csv`
puede ser llamada de la siguiente forma:

```{r, eval = F}
bg_chem <- read.csv("datos/5.1_BGchem2008data.csv")
```

Ahora debería tener un objeto llamado `bg_chem` de la clase `data.frame` en su ambiente
de trabajo. Verifique que esto es asta correcto.

Note que en las páginas de ayuda hay una gran cantidad de argumentos que no fue necesario 
utilizar. Algunos argumento en las llamadas a funciones son opcionales y algunos otros
son requeridos. Argumento opcionales serán mostrados en la sección de uso con un par de
`nombre = valor`, donde se muestra el valor por defecto. Si usted no especifica un par
`nombre = valor` para ese argumento cuando llame a la función, la función asumirá el valor
por defecto (ejemplo: `header = TRUE` para `read.csv`). Los argumentos requeridos solo 
mostrarán en nombre del argumento, sin un valor asociado. Fíjese que el único argumento
requerido para `read.csv` es `file`.

Siempre se puede especificar un argumento de la forma `nombre = valor`. Pero si no lo hace, 
R intentará identificarlos basado en el orden en que fueron entregados. De esta forma, en el 
comando de mas arriba, se asume que queremos `file = "data/BGchem2008data.csv"`, ya que _file_
es el primer argumento. Si queremos agregar algún otro argumento, por ejemplo 
`stringsAsFactors`, vamos a necesitar especificarlos usando `nombre = valor`, ya que el 
segundo argumento es `header`. Para las funciones que llamo comúnmente, 
uso esto sólo para los primeros 2 argumentos, para los que están en la 3a posición 
o posterior siempre uso el par `nombre = valor`.

Muchos usuarios de R (incluyéndome) sobrescriben el argumento por defecto de `stringsAsFactors`
usando la siguiente llamada:

```{r}
bg_chem <- read.csv("data/5.1_BGchem2008data.csv", stringsAsFactors = FALSE)
```

## Usando `data.frames`

Un `data.frame` es una estructura de datos de dos dimensiones en R, es similar a como se comporta 
como una hoja de cálculo. Un `data.frame` es una colección de filas y columnas de datos, donde cada 
columna tiene un nombre y representa una variable y que cada fila corresponde a una medición
de esa variable. De esta forma, cuando ejecutamos `read.csv`, el objeto `bg_chem` que fue creado
es un `data.frame`. Hay muchas formas para explorar data.frames en R y RStudio. A continuación
mostraremos algunos:

- clic en la palabra `bg_chem` en el ´panel _environment_
- clic en la flecha junto a `bg_chem` en el panel de _environment_
- ejecute `head(bg_chem)` en la consola
- ejecute `View(bg_chem)` en la consola

Usualmente las funciones se ejecutan en columnas individuales de un `data.frame`. Para llamar a una
columna específica se usa el operador `$`. Por ejemplo, digamos que se quiere mirar las primeras
filas solo de la columna `Date`. Para esto se debe ejecutar en la consola:

```{r}
head(bg_chem$Date)
```

¿Como calculamos la temperatura promedio de las muestras tomadas por el CTD?

```{r}
mean(bg_chem$CTD_Temperature)
```

O si quisiéramos guardar este promedio como una variable para ser utilizada después:

```{r}
temp_promedio <- mean(bg_chem$CTD_Temperature)
```

También es posible crear algunos gráficos simples utilizando este operador (`$`).

```{r}
plot(bg_chem$CTD_Depth, bg_chem$CTD_Temperature)
```

Existen muchas herramientas y funciones más avanzadas para crear mejores gráficos 
(incluso con una sintaxis más simple) en R. Veremos algunas de estos mas adelante.

### Actividad

> Ejercicio: Tome algunos minutos en explorar este set de datos. Pruebe algunas 
funciones en las columnas utilizando el operador para seleccionar una columna
única, experimente haciendo gráficos y generando resúmenes de los datos. 

## Solución de problemas

### Mi RMarkdown no general (knit) el PDF

Si se obtiene un error cuando se trata de general el PDF, donde dice que su computador
no tiene la instalación de LaTeX, existen dos posibles problemas:

1. Su computador no tiene LaTeX instalado
1. Su computados si tiene LaTeX instalado, pero RStudio no lo puede encontrar (no está
definida la ruta o path)

Si usted ya usa LaTeX (para escribir papers por ejemplo), seguro que su problema esté en la
segunda categoría. Arreglar esto sólo requiere redireccionar RStudio a donde este instalado
el LaTeX, pero esto no lo explicaremos acá.

Si su problema es que no tiene instalado LaTeX y está seguro que no lo tiene!! puse usar 
el paquete de R `tinytex`, este se instala muy fácilmente y es reconocido automáticamente
por RStudio. Para hacer esto solo necesita tener los derechos de administrador del 
computador.

Para instalar `tinytex` ejecute en la consola:

```{r, eval = F}
install.packages("tinytex")
tinytex::install_tinytex()
```
<!---
 Si se genera un error como `destino /XXX/XXX/ sin permisos de escritura`, solo necesita
dar los permisos de escrita a este directorio (y esto solo se puede hacer con permisos de 
administrador). To do this, run this command in the terminal:


    sudo chown -R `whoami`:admin /usr/local/bin

and then try the above install instructions again. More information about `tinytex` can be found [here](https://yihui.name/tinytex/)

--> 

### Acabo de ejecutar un comando para nada pasa

Esto puede ocurrir porque no completó el comando: ¿Se muestra un pequeño signo `+` en su consola?
R le esta diciendo que está esperando a que termine. En el ejemplo de más abajo falta cerrar el 
paréntesis.

```{r, eval=FALSE}
> x <- seq(1, 10
+ 
```

Se puede simplemente cerrar el paréntesis y apretar enter, o `esc` dos veces, lo que 
cancela la ejecución del comando.

### R dice que mi objeto no puede ser encontrado

Este error es muy común en usuario nuevos: `Error in mean(myobject) : object 'myobject' not found`

Esto significa que el objeto llamado `myobject` no existe en el ambiente de trabajo. Las razones
más comunes para este error son:

- **Error de tipeo**: asegúrese que el nombre de su objeto esta bien escrito, R hace diferencias
entre mayúsculas y minúsculas. Debe estar escrito _exactamente_ como fue creado.
- **No fue asignado a una variable**: note que los objetos solo son guardados en el 
ambiente de trabajo si fueron asignado con el operador de asignación, ej: 
`myobject <- read.csv(...)`
- **No ejecute la linea en RMarkdown**: recuerde que escribir una linea de código en RMarkdown no 
es lo mismo que escribir en la consola, usted tiene que ejecutar la linea de código usando 
_control + enter_, ejecutando la sección de código o por alguna de las otras formas que fueron
descritas en la sección de RMarkdown de este libro.

## Análisis literal

RMarkdown es una excelente forma de general análisis literales y flujos de trabajo reproducibles. [Aquí](https://nceas.github.io/sasap-training/materials/reproducible_research_in_r_fairbanks/example-brood-table-analysis.html) hay un ejemplo en inglés de un flujo de trabajo real escrito utilizando RMarkdown.

